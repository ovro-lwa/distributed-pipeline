# Dockerfile for testing orca-pipeline
FROM --platform=linux/amd64 continuumio/miniconda3:latest

WORKDIR /app

# Copy environment file first for better caching
COPY environment.yaml .

# Create the conda environment
RUN conda env create -f environment.yaml

# Make RUN commands use the new environment
SHELL ["conda", "run", "-n", "orca-env", "/bin/bash", "-c"]

# Copy the rest of the code
COPY . .

# Install test dependencies and package
RUN pip install pytest pytest-cov mock && pip install -e . --no-deps

# Run tests
CMD ["conda", "run", "-n", "orca-env", "pytest", "tests/", "-v", "--tb=short"]
